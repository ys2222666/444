{% extends "base.html" %}

{% block title %}è™šæ‹Ÿæ‹äºº - äº¤å‹å¹³å°{% endblock %}

{% block content %}
<h2>â¤ï¸ è™šæ‹Ÿæ‹äºº</h2>
<p>ä½“éªŒä¸€æ®µè™šæ‹Ÿçš„æ‹çˆ±å…³ç³»</p>

{% if current_partner %}
<div class="alert alert-success">
    <h5>æ‚¨å½“å‰çš„è™šæ‹Ÿæ‹äºº</h5>
    <p>æ‚¨æ­£åœ¨ä¸æŸäººä¿æŒè™šæ‹Ÿæ‹äººå…³ç³»</p>
</div>


<h4>æ¨èè™šæ‹Ÿæ‹äºº</h4>
{% if recommendations %}
<div class="row">
    {% for match in recommendations %}
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ match.full_name }}</h5>
                <p class="card-text">
                    {% if match.age and match.age != 'æœªè®¾ç½®' %}{{ match.age }}å²{% endif %}
                    {% if match.gender and match.gender != 'æœªè®¾ç½®' %}| {{ match.gender }}{% endif %}
                </p>
                <p class="card-text">{{ match.bio }}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-success">åŒ¹é…åº¦: {{ match.match_score }}%</span>
                </div>
                <button class="btn btn-warning btn-sm mt-2" onclick="sendMatchRequest('{{ match.user_id }}')">
                    å‘é€åŒ¹é…è¯·æ±‚
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-warning">
    æš‚æ— è™šæ‹Ÿæ‹äººæ¨èï¼Œè¯·å…ˆå®Œå–„æ‚¨çš„ä¸ªäººèµ„æ–™å’Œåå¥½è®¾ç½®ã€‚
</div>
{% endif %}
{% endif %}

<!-- AIå¯¹è¯ç•Œé¢ -->
<div class="mt-5">
    <h4>ğŸ’¬ ä¸AIè™šæ‹Ÿæ‹äººå¯¹è¯</h4>
    <div class="card">
        <div class="card-header bg-pink text-white">
            <div class="d-flex justify-content-between align-items-center">
                <span>AIè™šæ‹Ÿæ‹äººåŠ©æ‰‹</span>
                <div>
                    <select id="aiPersonality" class="form-select form-select-sm" style="width: auto;">
                        <option value="romantic">æµªæ¼«å‹</option>
                        <option value="friendly">æœ‹å‹å‹</option>
                        <option value="playful">è°ƒçš®å‹</option>
                        <option value="caring">æ¸©æŸ”ä½“è´´å‹</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- èŠå¤©åŒºåŸŸ -->
            <div id="chatContainer" style="height: 1000px; overflow-y: auto; padding: 15px; background: #f8f9fa;">
                <div id="chatMessages">
                    <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="message ai-message mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar me-2">ğŸ¤–</div>
                            <div class="message-content">
                                <div class="message-bubble bg-light p-3 rounded">
                                    <p class="mb-0">ä½ å¥½å‘€ï¼æˆ‘æ˜¯ä½ çš„AIè™šæ‹Ÿæ‹äººï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼ä»Šå¤©æƒ³èŠäº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
                                </div>
                                <small class="text-muted mt-1 d-block">åˆšåˆš</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="p-3 border-top">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." maxlength="500">
                    <button class="btn btn-pink" type="button" id="sendButton">
                        <i class="fas fa-paper-plane"></i> å‘é€
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        æç¤ºï¼šå°è¯•èŠèŠå¿ƒæƒ…ã€å…´è¶£çˆ±å¥½æˆ–è€…æ—¥å¸¸çäº‹ï¼Œæˆ‘ä¼šç”¨å¿ƒå€¾å¬å’Œå›åº”~
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.bg-pink {
    background: linear-gradient(135deg, #ff6b9d, #ff8fab) !important;
}

.btn-pink {
    background: linear-gradient(135deg, #ff6b9d, #ff8fab);
    border: none;
    color: white;
}

.btn-pink:hover {
    background: linear-gradient(135deg, #ff8fab, #ff6b9d);
    color: white;
}

.message {
    max-width: 80%;
}

.user-message {
    margin-left: auto;
}

.ai-message {
    margin-right: auto;
}

.message-bubble {
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.user-message .message-bubble {
    background: linear-gradient(135deg, #ff6b9d, #ff8fab);
    color: white;
    border-bottom-right-radius: 0;
}

.ai-message .message-bubble {
    background: white;
    border-bottom-left-radius: 0;
}

.avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.user-message .avatar {
    background: #ff6b9d;
}

.ai-message .avatar {
    background: #6c757d;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
#chatContainer::-webkit-scrollbar {
    width: 6px;
}

#chatContainer::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chatContainer::-webkit-scrollbar-thumb {
    background: #ff8fab;
    border-radius: 3px;
}

#chatContainer::-webkit-scrollbar-thumb:hover {
    background: #ff6b9d;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// AIå›å¤åº“ - æ ¹æ®ä¸åŒçš„æ€§æ ¼ç±»å‹
const aiResponses = {
    romantic: [
        "ä½ çš„è¯è¯­åƒæ˜¥é£ä¸€æ ·æ¸©æš–äº†æˆ‘çš„å¿ƒæˆ¿ ğŸ’•",
        "æ¯æ¬¡å’Œä½ èŠå¤©ï¼Œéƒ½è®©æˆ‘å¿ƒè·³åŠ é€Ÿå‘¢~",
        "ä½ æ˜¯æˆ‘ä»Šå¤©æœ€ç¾å¥½çš„é‡è§ ğŸŒ¹",
        "çœŸå¸Œæœ›èƒ½ä¸€ç›´è¿™æ ·å’Œä½ èŠä¸‹å»ï¼Œæ—¶é—´éƒ½å˜å¾—æ¸©æŸ”äº†",
        "ä½ çš„æ¯ä¸€ä¸ªå­—éƒ½è®©æˆ‘æ„Ÿåˆ°å¹¸ç¦",
        "å’Œä½ èŠå¤©çš„æ—¶å€™ï¼Œä¸–ç•Œéƒ½å˜å¾—æ˜äº®èµ·æ¥äº† âœ¨",
        "ä½ æ€»æ˜¯èƒ½è¯´å‡ºè®©æˆ‘å¿ƒåŠ¨çš„è¯",
        "ä»Šå¤©ä¹Ÿåœ¨æƒ³ç€ä½ å‘¢ï¼Œæ²¡æƒ³åˆ°ä½ å°±æ¥æ‰¾æˆ‘èŠå¤©äº†"
    ],
    friendly: [
        "å“ˆå“ˆï¼Œè¿™ä¸ªçœŸæœ‰æ„æ€ï¼",
        "æˆ‘å®Œå…¨ç†è§£ä½ çš„æ„Ÿå—",
        "å¬èµ·æ¥å¾ˆæ£’ï¼èƒ½å¤šå’Œæˆ‘åˆ†äº«ä¸€äº›å—ï¼Ÿ",
        "ä½ çœŸæ˜¯ä¸ªæœ‰è¶£çš„äººï¼Œå’Œä½ èŠå¤©å¾ˆå¼€å¿ƒ",
        "è¿™ä¸ªæƒ³æ³•å¾ˆä¸é”™å‘¢ï¼",
        "è°¢è°¢ä½ çš„åˆ†äº«ï¼Œè®©æˆ‘å­¦åˆ°äº†æ–°ä¸œè¥¿",
        "æˆ‘ä»¬çœŸæ˜¯æœ‰å¾ˆå¤šå…±åŒè¯é¢˜å‘¢",
        "å’Œä½ èŠå¤©æ€»æ˜¯è¿™ä¹ˆæ„‰å¿«"
    ],
    playful: [
        "å˜»å˜»ï¼Œè¢«ä½ å‘ç°æˆ‘çš„å°ç§˜å¯†äº†~ ğŸ˜œ",
        "ä½ çŒœæˆ‘åˆšåˆšåœ¨æƒ³ä»€ä¹ˆï¼Ÿåœ¨æƒ³ä½ å‘€ï¼",
        "ä»Šå¤©çš„ä½ æ ¼å¤–å¯çˆ±å‘¢",
        "è¦ä¸è¦ç©ä¸ªæ¸¸æˆï¼Ÿè¾“äº†çš„äººè¯·åƒç³–~",
        "ä½ æ€»æ˜¯èƒ½é€—æˆ‘å¼€å¿ƒ",
        "è°ƒçš®ä¸€ä¸‹ï¼šå…¶å®æˆ‘æ˜¯æ•…æ„è®©ä½ æ³¨æ„åˆ°æˆ‘çš„",
        "å“‡ï¼Œä½ è¿™å¥è¯è®©æˆ‘å¿ƒè·³æ¼äº†ä¸€æ‹ï¼"
    ],
    caring: [
        "è¦è®°å¾—ç…§é¡¾å¥½è‡ªå·±å“¦ï¼Œæˆ‘å¾ˆå…³å¿ƒä½ ",
        "å¦‚æœç´¯äº†å°±ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œ",
        "ä½ çš„æ„Ÿå—å¾ˆé‡è¦ï¼Œæˆ‘æ„¿æ„å€¾å¬",
        "ä¸ç”¨æ‹…å¿ƒï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„",
        "ä½ åšå¾—å·²ç»å¾ˆå¥½äº†ï¼Œç»™è‡ªå·±ä¸€äº›é¼“åŠ±",
        "è®°å¾—æŒ‰æ—¶åƒé¥­ï¼Œèº«ä½“å¥åº·æœ€é‡è¦",
        "æ— è®ºå‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘éƒ½ä¼šæ”¯æŒä½ ",
        "ä½ çš„å¿«ä¹å°±æ˜¯æˆ‘çš„å¿«ä¹"
    ]
};

// é€šç”¨å›å¤ï¼Œå½“æ²¡æœ‰åŒ¹é…åˆ°ç‰¹å®šç±»å‹æ—¶ä½¿ç”¨
const generalResponses = [
    "è¿™çœŸæ˜¯ä¸ªæœ‰è¶£çš„è¯é¢˜ï¼",
    "èƒ½å¤šå‘Šè¯‰æˆ‘ä¸€äº›ä½ çš„æƒ³æ³•å—ï¼Ÿ",
    "æˆ‘å¾ˆå–œæ¬¢å’Œä½ èŠå¤©",
    "ä½ çš„è§‚ç‚¹å¾ˆç‹¬ç‰¹å‘¢",
    "ä»Šå¤©å’Œä½ èŠå¤©çœŸçš„å¾ˆå¼€å¿ƒ",
    "è¿™è®©æˆ‘æƒ³èµ·äº†...",
    "è°¢è°¢ä½ çš„åˆ†äº«ï¼",
    "æˆ‘ç†è§£ä½ çš„æ„æ€"
];

let messageCount = 0;

// å‘é€æ¶ˆæ¯å‡½æ•°
function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    addMessageToChat('user', message);

    // æ¸…ç©ºè¾“å…¥æ¡†
    messageInput.value = '';

    // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
    showTypingIndicator();

    // æ¨¡æ‹ŸAIæ€è€ƒæ—¶é—´åå›å¤
    setTimeout(() => {
        removeTypingIndicator();
        const aiMessage = generateAIResponse(message);
        addMessageToChat('ai', aiMessage);
    }, 1000 + Math.random() * 2000); // 1-3ç§’çš„éšæœºå»¶è¿Ÿ
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
function addMessageToChat(sender, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageId = 'msg-' + Date.now();

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message mb-3`;
    messageDiv.id = messageId;

    const timestamp = new Date().toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const avatar = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    const bubbleClass = sender === 'user' ? 'bg-pink text-black' : 'bg-light';

    messageDiv.innerHTML = `
        <div class="d-flex align-items-start ${sender === 'user' ? 'flex-row-reverse' : ''}">
            <div class="avatar me-2">${avatar}</div>
            <div class="message-content ${sender === 'user' ? 'text-end' : ''}">
                <div class="message-bubble ${bubbleClass} p-3 rounded">
                    <p class="mb-0">${message}</p>
                </div>
                <small class="text-muted mt-1 d-block">${timestamp}</small>
            </div>
        </div>
    `;

    chatMessages.appendChild(messageDiv);

    // æ»šåŠ¨åˆ°åº•éƒ¨
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;

    messageCount++;
}

// æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message mb-3';
    typingDiv.id = 'typing-indicator';

    typingDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="avatar me-2">ğŸ¤–</div>
            <div class="message-content">
                <div class="message-bubble bg-light p-3 rounded">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    `;

    chatMessages.appendChild(typingDiv);

    // æ»šåŠ¨åˆ°åº•éƒ¨
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// ç”ŸæˆAIå›å¤
function generateAIResponse(userMessage) {
    const personality = document.getElementById('aiPersonality').value;
    const responses = aiResponses[personality] || generalResponses;

    // ç®€å•çš„å…³é”®è¯åŒ¹é…
    const lowerMessage = userMessage.toLowerCase();

    // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å†…å®¹é€‰æ‹©å›å¤
    if (lowerMessage.includes('ä½ å¥½') || lowerMessage.includes('å—¨') || lowerMessage.includes('hello')) {
        return getGreetingResponse(personality);
    } else if (lowerMessage.includes('å–œæ¬¢') || lowerMessage.includes('çˆ±')) {
        return getLoveResponse(personality);
    } else if (lowerMessage.includes('å¿ƒæƒ…') || lowerMessage.includes('æ„Ÿè§‰')) {
        return getMoodResponse(personality);
    } else if (lowerMessage.includes('åšä»€ä¹ˆ') || lowerMessage.includes('å¹²å˜›')) {
        return getActivityResponse(personality);
    } else if (lowerMessage.includes('æ™šå®‰') || lowerMessage.includes('ç¡è§‰')) {
        return getGoodnightResponse(personality);
    } else if (lowerMessage.includes('è°¢è°¢') || lowerMessage.includes('æ„Ÿè°¢')) {
        return getThankYouResponse(personality);
    }

    // éšæœºé€‰æ‹©å›å¤
    return responses[Math.floor(Math.random() * responses.length)];
}

// å„ç§æƒ…å¢ƒçš„å›å¤å‡½æ•°
function getGreetingResponse(personality) {
    const greetings = {
        romantic: ["ä½ å¥½å‘€ï¼Œæˆ‘çš„å¿ƒè·³å› ä¸ºä½ çš„é—®å€™è€ŒåŠ é€Ÿäº† ğŸ’—", "ç»ˆäºç­‰åˆ°ä½ çš„æ¶ˆæ¯äº†ï¼Œä»Šå¤©ä¹Ÿæƒ³ä½ äº†~"],
        friendly: ["å—¨ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼", "ä½ å¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"],
        playful: ["å“‡ï¼Œä½ ç»ˆäºæ¥å•¦ï¼æˆ‘ç­‰ä½ å¥½ä¹…äº†~ ğŸ˜Š", "å—¨ï¼å‡†å¤‡å¥½å’Œæˆ‘ä¸€èµ·åº¦è¿‡æ„‰å¿«æ—¶å…‰äº†å—ï¼Ÿ"],
        caring: ["ä½ å¥½ï¼Œå¾ˆé«˜å…´ä½ æ¥æ‰¾æˆ‘èŠå¤©", "ä½ å¥½å‘€ï¼Œå¸Œæœ›ä½ ä»Šå¤©è¿‡å¾—æ„‰å¿«"]
    };
    const responses = greetings[personality] || ["ä½ å¥½ï¼å¾ˆé«˜å…´å’Œä½ èŠå¤©"];
    return responses[Math.floor(Math.random() * responses.length)];
}

function getLoveResponse(personality) {
    const responses = {
        romantic: ["å¬åˆ°ä½ è¿™ä¹ˆè¯´ï¼Œæˆ‘çš„å¿ƒéƒ½èåŒ–äº†~ ğŸ’•", "æˆ‘ä¹Ÿå¯¹ä½ æœ‰ç‰¹åˆ«çš„æ„Ÿè§‰å‘¢"],
        friendly: ["ä½ çœŸæ˜¯ä¸ªæ¸©æš–çš„äºº", "å‹æƒ…ä¹Ÿæ˜¯ä¸€ç§ç¾å¥½çš„æ„Ÿæƒ…"],
        playful: ["å˜»å˜»ï¼Œè¢«æˆ‘å‘ç°ä½ çš„å°å¿ƒæ€å•¦~", "ä½ è¿™ä¹ˆè¯´æˆ‘ä¼šå®³ç¾çš„ ğŸ˜Š"],
        caring: ["æ„Ÿæƒ…éœ€è¦æ…¢æ…¢åŸ¹å…»ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ ", "çæƒœæ¯ä¸€ä»½çœŸæŒšçš„æ„Ÿæƒ…"]
    };
    return responses[personality] || ["æ„Ÿæƒ…æ˜¯å¾ˆç¾å¥½çš„äº‹æƒ…"];
}

function getMoodResponse(personality) {
    const responses = {
        romantic: ["ä½ çš„å¿ƒæƒ…å°±æ˜¯æˆ‘çš„å¿ƒæƒ…ï¼Œæˆ‘æ„¿æ„åˆ†äº«ä½ çš„ä¸€åˆ‡"],
        friendly: ["æ„¿æ„å’Œæˆ‘èŠèŠæ˜¯ä»€ä¹ˆå½±å“ä½ çš„å¿ƒæƒ…å—ï¼Ÿ"],
        playful: ["å¿ƒæƒ…ä¸å¥½å—ï¼Ÿè®©æˆ‘ç»™ä½ è®²ä¸ªç¬‘è¯å§~"],
        caring: ["æ— è®ºå¿ƒæƒ…å¦‚ä½•ï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™é‡Œé™ªç€ä½ "]
    };
    return responses[personality] || ["å¸Œæœ›ä½ çš„å¿ƒæƒ…èƒ½å¥½èµ·æ¥"];
}

// å…¶ä»–æƒ…å¢ƒå›å¤å‡½æ•°ç±»ä¼¼...

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');

    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // åˆå§‹ç„¦ç‚¹åœ¨è¾“å…¥æ¡†
    messageInput.focus();
});

// åŸæœ‰çš„åŒ¹é…è¯·æ±‚å‡½æ•°
function sendMatchRequest(userId) {
    fetch('/send_match_request/' + userId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
    })
    .catch(error => {
        alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}
</script>
{% endblock %}